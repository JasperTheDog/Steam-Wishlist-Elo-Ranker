<!doctype html>
<html>
<head>
<link rel="stylesheet" href="/theme.css">
<meta charset="utf-8" />
<title>Wishlist Elo â€" Settings</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #f9f9f9;
  }
  header {
    display:flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 32px;
    background: #ffffff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  h2 {
    margin: 0;
    font-size: 22px;
    font-weight: 600;
  }
  a.button {
    padding: 8px 18px;
    background: #007bff;
    color:white;
    border-radius:6px;
    text-decoration:none;
    font-weight:500;
    transition: background 0.2s;
  }
  a.button:hover {
    background: #0056b3;
  }
  .container {
    max-width: 800px;
    margin: 24px auto;
    padding: 0 16px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  .section {
    background: #fff;
    border-radius: 8px;
    padding: 16px 24px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
  }
  .section h3 {
    margin-top: 0;
  }
  .setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
  }
  .setting-item:last-child {
    border-bottom: none;
  }
  .setting-item .label {
    font-weight: 500;
  }
  .setting-item .desc {
    font-size: 14px;
    color: #555;
    margin-top: 4px;
  }
  .setting-item.slider-item {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  .slider-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .slider-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  /* Toggle Switch CSS */
  .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #28a745; }
  input:checked + .slider:before { transform: translateX(22px); }
  
  /* Range Slider CSS */
  .range-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e9ecef;
    outline: none;
    appearance: none;
    cursor: pointer;
  }
  .range-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.15s ease-in-out;
  }
  .range-slider::-webkit-slider-thumb:hover {
    background: #0056b3;
    transform: scale(1.1);
  }
  .range-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .range-slider::-moz-range-track {
    height: 6px;
    border-radius: 3px;
    background: #e9ecef;
  }
  .slider-value {
    display: inline-block;
    min-width: 60px;
    padding: 4px 12px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
    color: #495057;
  }
  .slider-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #6c757d;
    margin-top: 4px;
  }
  .backup-section {
    background: #fff;
    border: 1.5px solid #28a745;
    box-shadow: 0 1px 6px rgba(40,167,69,0.06);
  }
  .restore-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    width: 100%;
  }
  .restore-btn {
    padding: 6px 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }
  .restore-btn:hover {
    background: #0056b3;
  }
  .snapshot-btn {
    padding: 8px 18px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }
  .snapshot-btn:hover {
    background: #1e7e34;
  }
  @media (max-width: 600px) {
    .restore-row {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    .backup-section {
      padding: 12px 8px;
    }
    .slider-header {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
  }
</style>
</head>
<body>
<header>
  <h2>Settings</h2>
  <div style="display: flex; gap: 12px;">
    <a href="/index.html" class="button button-duel">Quick Duel</a>
    <a href="/leaderboard.html" class="button button-leaderboard">Leaderboard</a>
    <a href="/history.html" class="button button-history">History</a>
    <a href="/genres.html" class="button button-genres">Genres</a>
  </div>
</header>

  <div class="container">
    <div class="section">
        <h3>Duel Settings</h3>
        <div class="setting-item">
            <div>
                <div class="label">Winner Stays On</div>
                <div class="desc">After a vote, the winner remains for the next duel.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="winner-stays-on">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <div>
                <div class="label">Prefer New Choices</div>
                <div class="desc">Heavily discourage choosing a game shown in recent matches. Set value below.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="prefer-new-choices">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-item slider-item">
            <div class="slider-header">
                <div>
                    <div class="label">New Choices History Length</div>
                    <div class="desc">Number of recent matches to avoid when "Prefer New Choices" is enabled.</div>
                </div>
                <div class="slider-value" id="history-length-value">30</div>
            </div>
            <div class="slider-controls">
                <input type="range" id="history-length-slider" class="range-slider" min="0" max="100" value="30">
                <div class="slider-info">
                    <span>0 (disabled)</span>
                    <span id="max-games-text">100 (all games)</span>
                </div>
            </div>
        </div>
        <div class="setting-item">
            <div>
                <div class="label">Prefer Close Elo</div>
                <div class="desc">Prioritize pairing games with a similar rating.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="prefer-close-elo">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <div>
                <div class="label">Prefer Far Elo</div>
                <div class="desc">Prioritize pairing games with a very different rating.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="prefer-far-elo">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <div>
                <div class="label">Prefer Lower Played</div>
                <div class="desc">Prioritize pairing games that have been played less.</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="prefer-lower-played">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="section backup-section">
      <h3 style="color:#28a745; margin-top:0;">Backup &amp; Restore</h3>
      <div class="setting-item" style="flex-direction:column; align-items:flex-start; gap:16px; border-bottom:none; width:100%;">
        <div class="restore-row">
          <label for="restore-version" style="font-weight:500; margin-right:8px;">Restore previous version:</label>
          <select id="restore-version" style="min-width:160px; padding:6px 10px; border-radius:4px; border:1px solid #b7e4c7; background:#fff;"></select>
          <button id="restore-btn" class="restore-btn">Restore</button>
        </div>
        <div>
          <button id="snapshot-btn" class="snapshot-btn">Save Current Version</button>
        </div>
        <div class="desc" style="font-size:13px; color:#277d3a; margin-top:4px;">
          Create a backup of your current data, or restore from a previous version.
        </div>
      </div>
    </div>

    <div class="section">
      <h3 style="color:#c00;">Danger Zone</h3>
      <p>Reset all ratings, wins, losses, and total games played. History will also be cleared. Backups will be created automatically.</p>
      <button id="reset-btn" style="padding:10px 20px; background:#c00; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
        Reset All Ratings
      </button>
    </div>
  </div>

<script>
let settings = {};
let totalGames = 0;
const winnerStaysOn = document.getElementById('winner-stays-on');
const preferCloseElo = document.getElementById('prefer-close-elo');
const preferFarElo = document.getElementById('prefer-far-elo');
const preferLowerPlayed = document.getElementById('prefer-lower-played');
const preferNewChoices = document.getElementById('prefer-new-choices');
const historyLengthSlider = document.getElementById('history-length-slider');
const historyLengthValue = document.getElementById('history-length-value');
const maxGamesText = document.getElementById('max-games-text');

async function loadTotalGames() {
  try {
    const res = await fetch('/num_games');
    if (res.ok) {
      const data = await res.json();
      totalGames = data.num_games;
      historyLengthSlider.max = totalGames;
      maxGamesText.textContent = `${totalGames} (all games)`;
      
      // Update slider value if current setting exceeds total games
      if (parseInt(historyLengthSlider.value) > totalGames) {
        historyLengthSlider.value = totalGames;
        historyLengthValue.textContent = totalGames;
      }
    }
  } catch (error) {
    console.error('Failed to load total games:', error);
  }
}

async function loadSettings() {
  const res = await fetch('/settings');
  if (res.ok) {
      settings = await res.json();
      winnerStaysOn.checked = settings.winner_stays_on || false;
      preferNewChoices.checked = settings.prefer_new_choices || false;
      preferCloseElo.checked = settings.prefer_close_rating || false;
      preferFarElo.checked = settings.prefer_far_rating || false;
      preferLowerPlayed.checked = settings.prefer_lower_played || false;
      
      // Load history length setting
      const historyLength = settings.new_choices_history_length || 30;
      historyLengthSlider.value = historyLength;
      historyLengthValue.textContent = historyLength;
  }
}

async function saveSettings() {
    const newSettings = {
        winner_stays_on: winnerStaysOn.checked,
        prefer_new_choices: preferNewChoices.checked,
        prefer_close_rating: preferCloseElo.checked,
        prefer_far_rating: preferFarElo.checked,
        prefer_lower_played: preferLowerPlayed.checked,
        new_choices_history_length: parseInt(historyLengthSlider.value),
    };
    await fetch('/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(newSettings)
    });
}

// History length slider event handlers
historyLengthSlider.addEventListener('input', () => {
    const value = parseInt(historyLengthSlider.value);
    historyLengthValue.textContent = value;
});

historyLengthSlider.addEventListener('change', () => {
    saveSettings();
});

// Ensure only one "prefer" is active at a time
preferCloseElo.addEventListener('change', () => {
    if (preferCloseElo.checked) {
        preferFarElo.checked = false;
    }
    saveSettings();
});
preferFarElo.addEventListener('change', () => {
    if (preferFarElo.checked) {
        preferCloseElo.checked = false;
    }
    saveSettings();
});
preferLowerPlayed.addEventListener('change', () => {
    saveSettings();
});
winnerStaysOn.addEventListener('change', saveSettings);
preferNewChoices.addEventListener('change', saveSettings);

// Danger Zone Logic
document.getElementById("reset-btn").addEventListener("click", async () => {
    if(!confirm("Are you sure? This will reset all ratings, wins/losses, history, and stats.")) return;
    const res = await fetch('/reset_ratings', {method:'POST'});
    if(!res.ok){ alert('Reset failed'); return; }
    alert((await res.json()).message);
    loadTotalGames(); // Reload total games after reset
});

async function loadBackups() {
  const res = await fetch('/list_backups');
  if(!res.ok) return;
  const data = await res.json();
  const sel = document.getElementById('restore-version');
  sel.innerHTML = '';
  // Reverse the array before adding options
  data.backups.slice().reverse().forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.text = `Version ${v}`;
    sel.appendChild(opt);
  });
}
loadBackups();

document.getElementById('restore-btn').addEventListener('click', async () => {
  const version = document.getElementById('restore-version').value;
  if(!version) return;
  if(!confirm(`Are you sure you want to restore version ${version}? This will overwrite current data.`)) return;
  const res = await fetch('/restore_version', {
    method:'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({version})
  });
  if(!res.ok){ alert('Restore failed'); return; }
  const data = await res.json();
  alert(data.message);
  loadBackups();
  loadTotalGames(); // Reload total games after restore
});

document.getElementById('snapshot-btn').addEventListener('click', async () => {
  const res = await fetch('/save_snapshot', {method:'POST'});
  if(!res.ok){ alert('Snapshot failed'); return; }
  const data = await res.json();
  alert(data.message);
  loadBackups();
});

// Initial Load
loadTotalGames();
loadSettings();
</script>

</body>
</html>